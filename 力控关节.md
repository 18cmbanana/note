# 关节驱动器选型的逻辑整理

· 应用场景所要求的驱动器性能

在做具体选型之前，我们首先需要明确：四足机器人下的应用场景特征对驱动器的性能要求。简要总结可包括如下五点：1）高频动态响应能力；2）精确力反馈能力；3）低成本实现能力；4）一定的负载能力；5）紧凑的轴向空间实现能力。接下来具体解读各个性能点对驱动器各部件带来的选型要求。

1. 高频动态响应能力：【小于60的减速比减速箱+物理高刚度】

为了使四足机器人的整体运动性能呈现高动态性，即我们说的高频动态响应能力好，需要求相应的驱动关节呈现两个特征：1）输出速度高；2）力/位响应的通频带宽。对应到具体的驱动关节参数上，即为1）需使用较低减速比的减速箱（一般需至少控制在60以内）；2）物理结构上呈现高刚度，即无柔性元件。第1点所要求的高频动态响应能力，实际上就已经剔除了现在工业机械臂上，高减速比谐波减速器的驱动器方案，同时也祛除了科研界人形机器人中常用的串联弹性驱动器(SEA)方案，并将减速比限定在60以内。

2. 精确力反馈能力 + 3. 低成本实现能力：【小于30的减速比减速箱+电流环力反馈】

为了更好地与外界物理环境进行交互，需要求关节驱动器具备精确的力反馈能力。首先基于现有的力测量方案与第1点提到的高刚度物理结构，我们只能在：1）电流环；2）应变片中进行选择。其次考虑到低实现成本的因素，我们只能选择更加廉价且方便的电流环方案（应变片以及相应的机械结构载体一般实现成本会在千元级别）。而在电流环测量力（扭矩）的基础上，为了减小减速箱难以建模的静摩擦力（启动扭矩）给精确测量力带来的负面影响，至少应当选取30以下减速比。实际测试过在36减速比下，电流环做精确力控的性能——结果四个字：差强人意。因此简单地定量来说，30的减速比可能会是使用电流环做精确力控的上限。第2点与第3点所要求的精确力反馈能力与低成本的实现，框定了电流环力反馈的方案，同时也进一步地缩小了减速比的范围，即30以内。

4. 一定的负载能力：【力矩电机】

虽然说四足机器人相对于双足人形的尺寸和重量都较小，但毕竟也是归于腿足式机器人的范畴，自然对相应的负载能力，即关机驱动器的输出扭矩有一定的要求。在已经使用小减速比减速箱的前提下，电机的选型自然而然会倾向于扭矩输出能力强，但转速较低的力矩电机上。

5. 紧凑的轴向空间实现能力


# 高频动态响应 + 精确力反馈能力

## 40Khz电流环控制

矢量控制系统的电流环是对 iq进行控制，控制的是定子电流，进而控制电机转矩。电流内环的作用是在电机启动过程中能够以最大电流启动，同时在外部扰动是能够快速恢复，加快动态跟踪响应速度，提高系统的稳定性。电流内环的输入为电流信号的误差值，输出为参考电压，控制电动机转矩。第一个环节是PI调节器，第二个环节是延迟环节，第三个环节是PWM环节。

![image.png](https://s2.loli.net/2022/11/23/r17ylgHk6MO5vtE.png)

## 高速通信

运动控制系统处理机械系统中一个或多个坐标上的运动以及运动之间的协调，实现精确的位置控制、速度和加速度控制、转矩和力的控制等。典型的运动控制系统，从结构上看，包括上位机控制窗口、运动控制器、驱动器、电机以及测量反馈系统等几个部分组成：

![image.png](https://s2.loli.net/2022/11/23/dT35IH9eOyBLi4Y.png)

## 锁相环技术

系统通过控制iq来控制电磁转矩，从而电机开始转动。电机在转动的过程，传感器检测到机械角度会改变，也就是说电角度也会改变，由电角度在单位时间的变化，就可以求出电角速度，从而就可以得到反馈回来转速参与转速决策，最终可以控制转速稳定。

1. 什么是锁相环

锁相环是一种利用相位同步产生电压，去调谐压控振荡器以产生目标频率的负反馈控制系统。锁相环就是通过负反馈控制系统，让压控振荡器的固有振荡频率fo 和输入的参考信号fi 的相位保持在误差允许范围内，从而让振荡频率fo达到和参考信号fi 同步相位频率的目的。

2. 工作原理

在编码器测速算法中，通常情况下使用位置差分法实现速度的测量，也就是在一个时间周期内，记录前后位置差，用这个位置差除以时间就可以得到速度。由于编码器采样存在高频噪声，因此会造成速度计算的误差。该方法计算出来的速度，必须进行必要的滤波才能使用。

![image.png](https://s2.loli.net/2022/11/23/DFCEZ4OToLfys8M.png)

最基础的锁相环系统主要包含三个基本模块：鉴相器（Phase Detector：PD）、环路滤波器（L00P Filter：LF）其实也就是低通滤波器，和压控振荡器（Voltage Controlled Oscillator：VCO）。有了这三个模块的话，最基本的锁相环就可以运行了。

![image.png](https://s2.loli.net/2022/11/23/nW5RCe8xpcoSy9F.png)

3. 电机控制中的应用

![image.png](https://s2.loli.net/2022/11/23/oIrYpxwu8He3Umh.png)

## PID控制器

![image.png](https://s2.loli.net/2022/11/23/Pjpt1WCRGyas3EY.png)

### PID各自对差值调节对系统的影响


1、单独的P（比例）就是将差值进行成比例的运算，它的显著特点就是有差调节，有差的意义就是调节过程结束后，被调量不可能与设定值准确相等，它们之间一定有残差，残差具体值您可以通过比例关系计算出。增加比例将会有效减小残差并增加系统响应，但容易导致系统激烈震荡甚至不稳定。

2、单独的I（积分）就是使调节器的输出信号的变化速度与差值信号成正比，如果差值大，则积分环节的变化速度大，这个环节的正比常数的比例倒数我们在伺服系统里通常叫它为积分时间常数，积分时间常数越小意味着系统的变化速度越快，所以同样如果增大积分速度（也就是减小积分时间常数）将会降低控制系统的稳定程度，直到最后出现发散的震荡过程。这个环节最大的好处就是被调量最后是没有残差的。

3、PI（比例积分）就是综合P和I的优点，利用P调节快速抵消干扰的影响，同时利用I调节消除残差。

4、单独的D（微分）就是根据差值的方向和大小进行调节的，调节器的输出与差值对于时间的导数成正比，微分环节只能起到辅助的调节作用，它可以与其他调节结合成PD和PID调节。它的好处是可以根据被调节量（差值）的变化速度来进行调节，而不要等到出现了很大的偏差后才开始动作，其实就是赋予了调节器以某种程度上的预见性，可以增加系统对微小变化的响应特性。

5、PID综合作用可以使系统更加准确稳定的达到控制的期望。

伺服的电流环的PID常数一般都是在驱动器内部设定好的，操作使用者不需要更改。

速度环主要进行PI（比例和积分），比例就是增益，所以我们要对速度增益和速度积分时间常数进行合适的调节才能达到理想效果。

位置环主要进行P（比例）调节。对此我们只要设定位置环的比例增益就好了。

位置环、速度环的参数调节没有什么固定的数值，要根据外部负载的机械传动连接方式、负载的运动方式、负载惯量、对速度、加速度要求以及电机本身的转子惯量和输出惯量等等很多条件来决定，调节的简单方法是在根据外部负载的情况进行大体经验的范围内将增益参数从小往大调，积分时间常数从大往小调，以不出现震动超调的稳态值为最佳值进行设定。

当进行位置模式需要调节位置环时，最好先调节速度环（此时位置环的比例增益设定在经验值的最小值），调节速度环稳定后，再调节位置环增益，适量逐步增加，位置环的响应最好比速度环慢一点，不然也容易出现速度震荡。    

### 伺服三环控制为什么采用P+PI+PI方式


在哪里加积分环节取决于稳态误差发生在哪里。稳态误差总是由模型不完备造成的，哪一层的物理过程难以精确用线性数学模型精确表达，该层以上的某层闭环就要加积分环节。

当位置环下还有速度环时，速度和位置是对同一个刚体运动的不同数学描述，在物理上其实是同一个量。它们之间只存在严格的数学关系，并没有实际的物理过程。这就意味着位置是速度的积分这一模型是绝对精确的，因此不会产生稳态误差，自然也就不需要积分环节。换句话说，只要速度控制不存在稳态误差，那么系统总是可以精确收敛到目标位置。

通常速度环会加一个积分环节，这是因为在它的下下层，即扭矩->加速度层出现了建模不精确造成的稳态误差。扭矩到加速度间的关系是牛顿定律
$\tau_{drive}=J*\alpha+\tau_{ext}$
     
这个模型里转动惯量和包括摩擦力和负载扭矩在内的外加扭矩都不可能绝对精确得测量和估计，所以一定需要一个积分环节。然而加速度这一层因为加速度传感器在经济性和精确性上的限制很难获得加速度反馈形成闭环控制。因此大多数伺服系统都不存在加速度环，而是直接作为一个开环比例增益被合并到了速度环比例增益里。既然不存在加速度闭环，那么为了修正上述稳态误差的积分环节就只能被加到速度闭环里。

这个积分环节的作用很重要，它不止要处理扭矩到加速度的稳态误差，还要解决电机模型中电流到扭矩的误差。电流到扭矩之间的电磁过程存在难以精确建模的非线性特性，温度影响，以及加工装配误差。但是同样因为扭矩传感器高昂价格的限制，不到万不得已不会去搭建扭矩闭环，因此这一层的积分环节得一路往上加到速度环去，与刚才讨论过的积分环节合二为一。

再向下追溯，pwm驱动电压和电流之间也同样存在稳态误差，但所幸电流测量是很容易工程实现的，因此带积分环节的电流环是常规做法。



  
## PID 控制器抗积分饱和模型与算法


积分是 PID 控制器的一个环节，它的作用是为了消除单纯的比例控制所带来的系统静差，使控制更精准。当积分作用不断累加，执行机构达到极限时，控制器的输出 Uout 还在继续增大，但是执行机构不可能无限增大，这个时候控制器输出超出了正常范围，也就是进入了饱和区。

积分是 PID 控制器的一个环节，它的作用是为了消除单纯的比例控制所带来的系统静差，使控制更精准。当积分作用不断累加，执行机构达到极限时，控制器的输出 Uout 还在继续增大，但是执行机构不可能无限增大，这个时候控制器输出超出了正常范围，也就是进入了饱和区。

有很多解决积分饱和的方法，常见的一种方法是在计算输出量 Uout(k) 时，首先判断上一时刻的输出量 Uout(k-1) 是否已经超出了限制范围，如果输出量 Uout(k-1) 超出了限制范围的最大值，那么控制器只累加负偏差；如果输出量 Uout(k-1) 超出了限制范围的最小值，那么控制器只累加正偏差，这样能有效避免 PID 控制器的输出长时间滞留饱和区，提高控制器的响应能力。代码实现：

   ```c
    currentError = SetValue - SampingValue;
if(Uout > Umax){
    if(currentError < 0){
        IntegralIterm += Ki*currentError;
    }
} 
else if(Uout< Umin){
    if(currentError > 0){
        IntegralIterm +=Ki* currentError;
    }
}    
else{
    IntegralIterm +=Ki* currentError;
} 

ProportionIterm = kp*currentError;
DifferentialIterm = kd*(currentError - lastError);
Uout = ProportionIterm + IntegralIterm +DifferentialIterm;
lastError = currentError;
```

还有一种使用较多的方法，称为反馈抑制抗饱和算法 (back-calculation)，该算法在系统进入饱和区时，对积分引入负反馈，使其尽快退出饱和区。

![image.png](https://s2.loli.net/2022/11/23/wzLBsSqykFE7oUR.png)

u 为控制信号，kp 为比例系数，ki 为积分系数，kaw 是抗积分饱和系数，Ts 为采用周期，e 为偏差信号。通过比较饱和输出信号 Usat 与计算的非饱和控制信号 U 的偏差，并将该偏差乘以一个抗饱和积分系数 kaw，反馈到积分部分。代码实现：

```c

currentError = SetValue - SampingValue;

ProportionIterm = kp*currentError;
IntegralIterm += ki*currentError;
Differential = kd*(currentError - lastError);
antiWindupError = constrain(Uout,min,max)-Uout;
IntegralIterm += kaw*antiWindupError;
Uout = ProportionIterm + IntegralIterm + Differential;
lastError = currentError;
```

其中 constrain 函数是检查Uout是否超出最大或最小限制值,如果超过则输出限制值，kaw 系数可以在 (0.1~3.0)*ki/kd 之间选择。